#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [[ ! -f "hugo.yaml" ]]; then
    echo -e "${RED}Error: This script must be run from the blog root directory${NC}"
    exit 1
fi

echo -e "${BLUE}üìù Creating a new snippet...${NC}\n"

# Get the title
echo -e "${YELLOW}üìù Enter snippet title:${NC}"
TITLE=$(gum input --placeholder "My awesome snippet...")
if [[ -z "$TITLE" ]]; then
    echo -e "${RED}Error: Title cannot be empty${NC}"
    exit 1
fi

# Get tags (comma-separated)
echo -e "${YELLOW}üè∑Ô∏è  Enter tags (comma-separated, optional):${NC}"
TAGS_INPUT=$(gum input --placeholder "javascript, tips, tools" --value "")

# Process tags
if [[ -n "$TAGS_INPUT" ]]; then
    # Split tags by comma and clean them up
    IFS=',' read -ra TAGS_ARRAY <<< "$TAGS_INPUT"
    TAGS_FORMATTED="["
    for i in "${!TAGS_ARRAY[@]}"; do
        # Trim whitespace and convert to lowercase
        TAG=$(echo "${TAGS_ARRAY[$i]}" | xargs | tr '[:upper:]' '[:lower:]')
        if [[ $i -eq 0 ]]; then
            TAGS_FORMATTED+="\"$TAG\""
        else
            TAGS_FORMATTED+=", \"$TAG\""
        fi
    done
    TAGS_FORMATTED+="]"
else
    TAGS_FORMATTED="[]"
fi

# Generate slug from title
SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')

# Create directory
SNIPPET_DIR="content/snippets/$SLUG"
mkdir -p "$SNIPPET_DIR"

# Get current date in Hugo format
CURRENT_DATE=$(date "+%Y-%m-%dT%H:%M:%S%z" | sed 's/\([0-9][0-9]\)$/:\1/')

# Create the snippet file
cat > "$SNIPPET_DIR/index.md" << EOF
---
title: "$TITLE"
date: $CURRENT_DATE
tags: $TAGS_FORMATTED
---

<!-- Write your snippet content here -->

EOF

echo -e "${GREEN}‚úÖ Snippet created successfully!${NC}"
echo -e "${YELLOW}üìÅ Location: $SNIPPET_DIR/index.md${NC}"
echo -e "${YELLOW}üîó URL: /snippets/$SLUG/${NC}"
echo ""

# Ask if they want to open the file
if gum confirm "Open the snippet file in your default editor?"; then
    if command -v code &> /dev/null; then
        code "$SNIPPET_DIR/index.md"
    elif command -v vim &> /dev/null; then
        vim "$SNIPPET_DIR/index.md"
    elif command -v nano &> /dev/null; then
        nano "$SNIPPET_DIR/index.md"
    else
        echo -e "${YELLOW}No suitable editor found. File location: $SNIPPET_DIR/index.md${NC}"
    fi
fi

echo -e "\n${BLUE}üí° To preview your snippet, run: hugo server${NC}"